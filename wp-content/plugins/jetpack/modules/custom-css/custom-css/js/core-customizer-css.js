(function(wp,$,api){api.controlConstructor.jetpackCss=api.Control.extend({modes:{'default':'text/css','less':'text/x-less','sass':'text/x-scss'},_updating:false,ready:function(){this.opts=window._jp_css_settings;this.$input=$('<textarea />',{name:this.setting.id,'class':'for-codemirror hidden'}).val(this.setting());this.container.append(this.$input);api(this.setting.id,_.bind(function(setting){var element=new api.Element(this.$input);this.elements=[element];element.sync(setting);element.set(setting());},this));if(this.opts.useRichEditor){this.initCodeMirror();}else{this.$input.removeClass('hidden');}
api.bind('ready',_.bind(this.addLabels,this));},initCodeMirror:function(){this.editor=window.CodeMirror.fromTextArea(this.$input.get(0),{mode:this.getMode(),lineNumbers:true,tabSize:2,indentWithTabs:true,lineWrapping:true});this.addListeners();},addListeners:function(){var edited=false;$('#accordion-section-custom_css > .accordion-section-title').click(_.bind(_.debounce(this.editor.refresh,250),this.editor));this.editor.on('focus',function(editor){editor.refresh();});this.editor.on('change',_.bind(function(editor){this._updating=true;this.$input.val(editor.getValue()).trigger('change');this._updating=false;if(!edited){window.ga&&window.ga('send','event','Customizer','Typed Custom CSS');edited=true;}},this));this.editor.on('focus',function(){window.ga&&window.ga('send','event','Customizer','Focused CSS Editor');});this.setting.bind('change',_.bind(this.externalChange,this));},getMode:function(){var mode=api('jetpack_custom_css[preprocessor]')();if(''===mode||!this.modes[mode]){mode='default';}
return this.modes[mode];},externalChange:function(){if(!this._updating){this.editor.setValue(this.setting());}},refresh:function(id){if('accordion-section-custom_css'===id){setTimeout(_.bind(function(){this.editor.refresh();},this),300);}},addLabels:function(){this.addTitle('jetpack_css_mode_control',this.opts.l10n.mode);this.addTitle('jetpack_mobile_css_control',this.opts.l10n.mobile);this.addDesc('wpcom_custom_css_content_width_control',this.opts.l10n.contentWidth);var widthControl=this._getControl('wpcom_custom_css_content_width_control');if(widthControl){widthControl.find('input').after('<span>px</span>');}
$('<div />',{id:'css-help-links','class':'css-help'}).appendTo(this.container);$('<a />',{id:'help-link',target:'_blank',href:this.opts.cssHelpUrl,text:this.opts.l10n.css_help_title}).prependTo('#css-help-links');if(this.opts.areThereCssRevisions){$('<a />',{id:'revisions-link',target:'_blank',href:this.opts.revisionsUrl,text:this.opts.l10n.revisions}).prependTo('#css-help-links');}},addTitle:function(controlId,title){var control=this._getControl(controlId);if(control){control.prepend('<span class="customize-control-title">'+title+'<span>');}},addDesc:function(controlId,desc){var control=this._getControl(controlId);if(control){control.append('<span class="description">'+desc+'<span>');}},_getControl:function(controlId){var control=api.control.value(controlId);if(control){return control.container;}
return null;}});})(window.wp,jQuery,window.wp.customize);