window.wp=window.wp||{};(function(exports,$){var Uploader,vp;if(typeof _wpPluploadSettings==='undefined'){return;}
Uploader=function(options){var self=this,isIE=navigator.userAgent.indexOf('Trident/')!==-1||navigator.userAgent.indexOf('MSIE ')!==-1,elements={container:'container',browser:'browse_button',dropzone:'drop_element',},key,error;this.supports={upload:Uploader.browser.supported,};this.supported=this.supports.upload;if(!this.supported){return;}
this.plupload=$.extend(true,{multipart_params:{}},Uploader.defaults);this.container=document.body;$.extend(true,this,options);for(key in this){if($.isFunction(this[key])){this[key]=$.proxy(this[key],this);}}
for(key in elements){if(!this[key]){continue;}
this[key]=$(this[key]).first();if(!this[key].length){delete this[key];continue;}
if(!this[key].prop('id')){this[key].prop('id','__wp-uploader-id-'+Uploader.uuid++);}
this.plupload[elements[key]]=this[key].prop('id');}
if(!(this.browser&&this.browser.length)&&!(this.dropzone&&this.dropzone.length)){return;}
if(!isIE&&'flash'===plupload.predictRuntime(this.plupload)&&(!this.plupload.required_features||!this.plupload.required_features.hasOwnProperty('send_binary_string'))){this.plupload.required_features=this.plupload.required_features||{};this.plupload.required_features.send_binary_string=true;}
this.uploader=new plupload.Uploader(this.plupload);delete this.plupload;this.param(this.params||{});delete this.params;if(typeof exports.VideoPress!=='undefined'){vp=exports.VideoPress;}else{window.console&&window.console.error('The VideoPress object was not loaded. Errors may occur.');}
error=function(message,data,file){if(file.attachment){file.attachment.destroy();}
Uploader.errors.unshift({message:message||pluploadL10n.default_error,data:data,file:file,});self.error(message,data,file);};this.uploader.bind('init',function(uploader){var timer,active,dragdrop,dropzone=self.dropzone;dragdrop=self.supports.dragdrop=uploader.features.dragdrop&&!Uploader.browser.mobile;if(!dropzone){return;}
dropzone.toggleClass('supports-drag-drop',!!dragdrop);if(!dragdrop){return dropzone.unbind('.wp-uploader');}
dropzone.bind('dragover.wp-uploader',function(){if(timer){clearTimeout(timer);}
if(active){return;}
dropzone.trigger('dropzone:enter').addClass('drag-over');active=true;});dropzone.bind('dragleave.wp-uploader, drop.wp-uploader',function(){timer=setTimeout(function(){active=false;dropzone.trigger('dropzone:leave').removeClass('drag-over');},0);});self.ready=true;$(self).trigger('uploader:ready');});this.uploader.bind('postinit',function(up){up.refresh();self.init();});this.uploader.init();if(this.browser){this.browser.on('mouseenter',this.refresh);}else{this.uploader.disableBrowse(true);$('#'+this.uploader.id+'_html5_container').hide();}
this.uploader.bind('FilesAdded',function(up,files){_.each(files,function(file){var attributes,image;if(plupload.FAILED===file.status){return;}
attributes=_.extend({file:file,uploading:true,date:new Date(),filename:file.name,menuOrder:0,uploadedTo:wp.media.model.settings.post.id,},_.pick(file,'loaded','size','percent'));image=/(?:jpe?g|png|gif|webp)$/i.exec(file.name);if(image){attributes.type='image';attributes.subtype='jpg'===image[0]?'jpeg':image[0];}
file.attachment=wp.media.model.Attachment.create(attributes);Uploader.queue.add(file.attachment);self.added(file.attachment);});up.refresh();up.start();});this.uploader.bind('UploadProgress',function(up,file){file.attachment.set(_.pick(file,'loaded','percent'));self.progress(file.attachment);});this.uploader.bind('FileUploaded',function(up,file,response){var complete;try{response=JSON.parse(response.response);}catch(e){return error(pluploadL10n.default_error,e,file);}
if(typeof response.media!=='undefined'){response=vp.handleRestApiResponse(response,file);}else{response=vp.handleStandardResponse(response,file);}
_.each(['file','loaded','size','percent'],function(key){file.attachment.unset(key);});file.attachment.set(_.extend(response.data,{uploading:false}));var att=wp.media.model.Attachment.get(response.data.id,file.attachment);if(typeof response.media!=='undefined'){att.sync('read').then(function(data){wp.media.model.Attachment.get(att.id).set(data);});}
complete=Uploader.queue.all(function(attachment){return!attachment.get('uploading');});if(complete){vp&&vp.resetToOriginalOptions(up);Uploader.queue.reset();}
self.success(file.attachment);});this.uploader.bind('Error',function(up,pluploadError){var message=pluploadL10n.default_error;for(var key in Uploader.errorMap){if(pluploadError.code===plupload[key]){message=Uploader.errorMap[key];if(_.isFunction(message)){message=message(pluploadError.file,pluploadError);}
break;}}
if('response'in pluploadError){try{var pluploadResponseObject=JSON.parse(pluploadError.response);if(typeof pluploadResponseObject==='object'){if('errors'in pluploadResponseObject&&typeof pluploadResponseObject.errors==='object'){pluploadResponseObject=pluploadResponseObject.errors.shift();}
if('message'in pluploadResponseObject){message=pluploadResponseObject.message;}}}catch(e){}}
error(message,pluploadError,pluploadError.file);vp&&vp.resetToOriginalOptions(up);up.refresh();});this.uploader.bind('UploadComplete',function(up){vp&&vp.resetToOriginalOptions(up);});this.uploader.bind('BeforeUpload',function(up,file){if(typeof file.videopress!=='undefined'){vp.originalOptions.url=up.getOption('url');vp.originalOptions.multipart_params=up.getOption('multipart_params');vp.originalOptions.file_data_name=up.getOption('file_data_name');up.setOption('file_data_name','media[]');up.setOption('url',file.videopress.upload_action_url);up.setOption('headers',{Authorization:'X_UPLOAD_TOKEN token="'+
file.videopress.upload_token+
'" blog_id="'+
file.videopress.upload_blog_id+
'"',});}});};$.extend(Uploader,_wpPluploadSettings);Uploader.uuid=0;Uploader.errorMap={FAILED:pluploadL10n.upload_failed,FILE_EXTENSION_ERROR:pluploadL10n.invalid_filetype,IMAGE_FORMAT_ERROR:pluploadL10n.not_an_image,IMAGE_MEMORY_ERROR:pluploadL10n.image_memory_exceeded,IMAGE_DIMENSIONS_ERROR:pluploadL10n.image_dimensions_exceeded,GENERIC_ERROR:pluploadL10n.upload_failed,IO_ERROR:pluploadL10n.io_error,HTTP_ERROR:pluploadL10n.http_error,SECURITY_ERROR:pluploadL10n.security_error,FILE_SIZE_ERROR:function(file){return pluploadL10n.file_exceeds_size_limit.replace('%s',file.name);},};$.extend(Uploader.prototype,{param:function(key,value){if(arguments.length===1&&typeof key==='string'){return this.uploader.settings.multipart_params[key];}
if(arguments.length>1){this.uploader.settings.multipart_params[key]=value;}else{$.extend(this.uploader.settings.multipart_params,key);}},init:function(){},error:function(){},success:function(){},added:function(){},progress:function(){},complete:function(){},refresh:function(){var node,attached,container,id;if(this.browser){node=this.browser[0];while(node){if(node===document.body){attached=true;break;}
node=node.parentNode;}
if(!attached){id='wp-uploader-browser-'+this.uploader.id;container=$('#'+id);if(!container.length){container=$('<div class="wp-uploader-browser" />').css({position:'fixed',top:'-1000px',left:'-1000px',height:0,width:0,}).attr('id','wp-uploader-browser-'+this.uploader.id).appendTo('body');}
container.append(this.browser);}}
this.uploader.refresh();},});Uploader.queue=new wp.media.model.Attachments([],{query:false});Uploader.errors=new Backbone.Collection();exports.Uploader=Uploader;})(wp,jQuery);