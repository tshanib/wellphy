(function($){var $ids;var $thumbs;$(function(){$(document.body).on('click','.gallery-widget-choose-images',function(event){event.preventDefault();var widget_form=$(this).closest('form, .form');$ids=widget_form.find('.gallery-widget-ids');$thumbs=widget_form.find('.gallery-widget-thumbs');var idsString=$ids.val();var attachments=getAttachments(idsString);var selection=null;var editing=false;if(attachments){selection=getSelection(attachments);editing=true;}
var options={state:'gallery-edit',title:wp.media.view.l10n.addMedia,multiple:true,editing:editing,selection:selection,};var workflow=getWorkflow(options);workflow.open();});$('.widget-inside').on('change','.gallery-widget-style',setupStyleOptions);setupStyleOptions();});var media=wp.media,l10n;l10n=media.view.l10n=typeof _wpMediaViewsL10n==='undefined'?{}:_wpMediaViewsL10n;media.view.MediaFrame.GalleryWidget=media.view.MediaFrame.Post.extend({createStates:function(){var options=this.options;if('CollectionEdit'in media.controller){this.states.add([new media.controller.CollectionEdit({type:'image',collectionType:'gallery',title:l10n.editGalleryTitle,SettingsView:media.view.Settings.Gallery,library:options.selection,editing:options.editing,menu:'gallery',}),new media.controller.CollectionAdd({type:'image',collectionType:'gallery',title:l10n.addToGalleryTitle,}),]);}else{if(!('WidgetGalleryEdit'in media.controller)){media.controller.WidgetGalleryEdit=media.controller.GalleryEdit.extend({gallerySettings:function(){return;},});}
this.states.add([new media.controller.WidgetGalleryEdit({library:options.selection,editing:options.editing,menu:'gallery',}),new media.controller.GalleryAdd({}),]);}},});function setupStyleOptions(){$('.widget-inside .gallery-widget-style').each(function(){var style=$(this).val();var form=$(this).parents('form');switch(style){case 'slideshow':form.find('.gallery-widget-link-wrapper').hide();form.find('.gallery-widget-columns-wrapper').hide();break;default:form.find('.gallery-widget-link-wrapper').show();form.find('.gallery-widget-columns-wrapper').show();}});}
function setupThumbs(selection,wrapper){wrapper.empty();var imageSize=_wpGalleryWidgetAdminSettings.thumbSize;selection.each(function(model){var sizedUrl=model.get('url')+'?w='+imageSize+'&h='+imageSize+'&crop=true';var thumb=jQuery('<img>',{src:sizedUrl,alt:model.get('title'),title:model.get('title'),width:imageSize,height:imageSize,class:'thumb',});wrapper.append(thumb);});}
function getAttachments(idsString){if(!idsString){return null;}
var shortcode=wp.shortcode.next('gallery','[gallery ids="'+idsString+'"]');shortcode=shortcode.shortcode;var attachments=wp.media.gallery.attachments(shortcode);return attachments;}
function getSelection(attachments){var selection=new wp.media.model.Selection(attachments.models,{props:attachments.props.toJSON(),multiple:true,});selection.gallery=attachments.gallery;selection.more().done(function(){selection.props.set({query:false});selection.unmirror();selection.props.unset('orderby');});return selection;}
function getWorkflow(options){var workflow=new wp.media.view.MediaFrame.GalleryWidget(options);workflow.on('update',function(selection){var state=workflow.state();selection=selection||state.get('selection');if(!selection){return;}
var ids=selection.map(function(model){return model.get('id');});var id_string=ids.join(',');$ids.val(id_string).trigger('change');setupThumbs(selection,$thumbs);},this);workflow.setState(workflow.options.state);return workflow;}})(jQuery);